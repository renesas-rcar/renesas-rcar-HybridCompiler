link:../index.adoc[=> Click to go back to index.adoc]

[[data_reader]]
=== DataReader

// tag::data_reader[]
* The data reader is responsible for reading the required data, converting it to the appropriate format, and feeding it into the network.
* Users must create each DataReader by themselves according to their use case. If pre-processing is required, it must also be implemented within the DataReader.
* Examples of DataReader creation and pre-processing are at this https://github.com/microsoft/onnxruntime-inference-examples/blob/main/quantization/image_classification/cpu/resnet50_data_reader.py[link].
// end::data_reader[]

[[legalization-functions]]
=== Legalization

The following legalizations are currently supported.

[options="header"]
|===
| legalization                   | description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | optional
| `extract_shared_initializer()` | If an initializer is shared by multiple nodes, the legalization makes a copy of the initializer and updates the node inputs to ensure that the initializer used by each node is unique in the graph.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | no, default pre-process  
| `deconv_bn_fuser()`            | Fuse "ConvTranspose->BatchNormalization" pattern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | no, default pre-process  
| `hardsigmoid_fuser()`          | Fuse "Add->Div->Clip" pattern into HardSigmoid.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | no, default pre-process  
| `hardswish_fuser()`            | Fuse "HardSigmoid->Mul" pattern into HardSwish.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | no, default pre-process  
| `lpnormalization_fuser()`      | Fuse "Abs->Pow->ReduceSum->Pow->Clip->Expand->Div" pattern into LpNormalization.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     | no, default pre-process  
| `remove_1xresize()`            | Remove Resize with identical input and output.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | no, default pre-process  
| `remove_nop_slice()`           | Remove Slice with identical input and output.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | no, default pre-process  
| `FusionGelu()`                 | The GeLU activation layer, such as in the Transformer system model, may be represented as a sequence of multiple operators instead of a single operator on ONNX. When represented as a sequence of multiple operators, QuantizeLinear and DequantizeLinear are inserted between each operator, which not only reduces accuracy but also reduces performance since they are executed as separate operator kernels. Setting extra_options["EnableGeluFusion"]=true will replace the operator sequence corresponding to GeLU in the input ONNX model with com.microsoft.Gelu. Setting extra_options["EnableGeluFusion"]=true will replace the operator sequence corresponding to GeLU in the input ONNX model with com.microsoft.Gelu. | yes, set "EnableGeluFusion" as true in extra_options to enable it  
| `insert_preproconv()`          | This option allows CNNIP to perform pre-processing. Specifically, a conv layer for preprocessing is inserted at the beginning of the ONNX model. This option assumes that uint8 format is specified for the preprocessing conv. Therefore, the uint8 option is automatically set when this option is enabled. For more information on uint8 format, please refer to the uint8 section.                                                                                                                                                                                                                                                                                                                                              | yes, set "InsertPreprocess" as true in extra_options to enable it 
| `merge_norm_to_conv2d`         | Merged Normalization into Conv2d.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | yes, set "MergeNormToConv2d" as true in extra_options to enable it
| `format_attention_block()`     | Format various attention blocks into a formalized pattern.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           | no, default pre-process    
| `convert_reducemean()`         | Convert ReduceMean to GlobalAveragePool for better performance.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | yes, set "ReduceMean2Gap" as true in extra_options to enable it
|===

link:../index.adoc[=> Click to go back to index.adoc]
